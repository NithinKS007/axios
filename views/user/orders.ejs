<%- include('../layouts/userLayouts/header') %>
<%- include('../layouts/userLayouts/navbar1') %>
<main class="main">
    <section style="padding-top: 100px; padding-bottom: 100px;">
        <div class="container">
            <div class="row">
                <div class="col-lg-10 m-auto">
                    <div class="row">
                        <%- include('../layouts/userLayouts/sidebar') %>
                        <div class="col-md-8">
                            <div class="container mt-3">
                                <h2 class="h2" style="font-size: 24px; font-weight: bold; color: #333; margin-bottom: 1rem;">MANAGE YOUR ORDERS</h2>
                                
                                <% if (orderData && orderData.length > 0) { %>
                                    <% orderData.forEach(order => { %>
                                        <div class="order-card card mb-3" style="border-radius: 10px;">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-center" data-bs-toggle="collapse" data-bs-target="#orderDetails-<%= order._id %>">
                                                    <div>
                                                        <p class="mb-1"><strong>Order Number:</strong> #<%= order._id %></p>
                                                        <p class="mb-1"><strong>Total:</strong> ₹ <%= order.totalAmount %></p>
                                                    </div>
                                                    <div class=" text-warning">
                                                        <strong><%= order.orderStatus.toUpperCase() %></strong>
                                                    </div>
                                                </div>
                                                <div id="orderDetails-<%= order._id %>" class="collapse">
                                                    <hr>
                                                    <div class="mb-3">
                                                        <p class="mb-1">Order Date: <%= new Date(order.orderDate).toLocaleDateString() %></p>
                                                        <p class="mb-1">Ship To: <%= order.shippingAddress.name %></p>
                                                    </div>
                                                    <% order.items.forEach(item => { %>
                                                        <div class="d-flex mb-3">
                                                            <div class="flex-shrink-0 me-3" style="width: 50px;">
                                                                <% if (item.images && item.images.length > 0) { %>
                                                                    <% 
                                                                    const fullPath = item.images[0];
                                                                    const filename = fullPath.split('\\').pop().split('/').pop();
                                                                    %>
                                                                    <img src="/productImages/<%= filename %>" alt="Product Image" class="img-fluid">
                                                                <% } else { %>
                                                                    <span>No image</span>
                                                                <% } %>
                                                            </div>
                                                            <div class="flex-grow-1" >
                                                                <p class="mb-1"><strong>Name:</strong> <%= item.productName %></p>
                                                                <p class="mb-0"><strong>Price:</strong> ₹ <%= item.price %> inc GST</p>
                                                                <p class="mb-0  text-warning"><strong>Status: <%= item.orderProductStatus.toUpperCase() %></strong></p>
                                                            </div>
                                                            
                                                            <div>
                                                                
                                                            
                                                                <% if (item.orderProductStatus !== 'delivered') { %>
                                                                    <button id="cancelProductButton<%= item._id %>" class="btn btn-sm" 
                                                                        onclick="cancelProduct('<%= item._id %>', '<%= order._id %>', '<%= item.orderProductStatus %>')"
                                                                        <%= item.orderProductStatus === 'cancelled' ? 'disabled' : '' %> >
                                                                        <%= item.orderProductStatus === 'cancelled' ? 'Cancelled' : 'Cancel' %>
                                                                    </button>
                                                                <% } else { %>
                                                                    <button id="returnProductButton<%= item._id %>" class="btn btn-primary btn-sm" 
                                                                        onclick="returnProduct('<%= item._id %>', '<%= order._id %>')">
                                                                        Return
                                                                    </button>
                                                                <% } %>
                                                                
                                                            </div>
                                                        </div>
                                                    <% }); %>
                                                    <!-- <div class="text-end">
                                                        <% if (order.orderStatus!=='delivered') { %>
                                                            <button class="btn btn-secondary btn-sm">Invoice</button>
                                                            <button class="btn btn-danger btn-sm" onclick="cancelOrder('<%= order._id %>', '<%= order.orderStatus %>')">Cancel Order</button>
                                                        <% } %>
                                                         </div> -->
                                                </div>
                                            </div>
                                        </div>
                                    <% }); %>
                                <% } else { %>
                                    <p>No orders found.</p>
                                <% } %>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</main>

<%- include('../layouts/userLayouts/footer') %>



<script>
  const cancelProduct = (itemId, orderId,orderProductStatus) => {
   
    console.log(`Cancel product ${itemId} in order ${orderId},${orderProductStatus}`);

    const confirmUpdate = window.confirm("Are you sure you want to cancel the product")

    if(confirmUpdate){

        fetch(`http://localhost:7000/orders`,{

            method:"PATCH",
            headers:{

                "Content-Type":"application/json"
            },

            body:JSON.stringify({itemId, orderId,orderProductStatus})

            }).then((response)=>{

                if (!response.ok) {

                return response.json().then(errorData => {

                    throw new Error(errorData.error || "Network response was not ok");

                });
            }

                return response.json()

            }).then((data)=>{

                console.log(data);
                if(data.success){

                const button = document.getElementById(`cancelProductButton${itemId}`);
                button.disabled = true;
                button.textContent = 'Cancelled';
              }



            }).catch((error)=>{

                console.log(`you have already cancelled the product`);
                alert(`Error: ${error.message}`);


            })
    }
    
};

const cancelOrder = (orderId,orderStatus) => {
    
    console.log(`Cancel order ${orderId},${orderStatus}`);

    fetch(`http://localhost:7000/orders`,{

        method:"PUT",
        headers:{

             "Content-Type":"application/json"

        },
        body:JSON.stringify({orderId,orderStatus})

     }).then((response)=>{

        if(!response.ok){

            throw new Error("Network response was not ok")
        }

        return response.json()

     }).then((data)=>{

        console.log(`data received`,data);

        
     })

};


</script>
